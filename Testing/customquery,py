import requests
import re
import json
import os
import httpx
# import socket, urllib3.util.connection as cn
# cn.allowed_gai_family = lambda: socket.AF_INET

script_dir = os.path.dirname(os.path.abspath(__file__))


graphql = False

url = "https://www.bahn.de/web/api/angebote/fahrplan"

with open(os.path.join(script_dir,"..","Configs","body.json"),"r",encoding="utf-8") as qf:
    payload = json.load(qf,)

json_data = json.dumps(payload)  # keep umlauts as-is

with open(os.path.join(script_dir,"..","Configs","headers.json"),"r") as qf:
    headers = json.load(qf)



for i in range(1000):
    count = i
    response = requests.post(
        url,
        headers=headers,
        data=json_data.encode("utf-8")  # explicit UTF-8 encoding
    )   
    print(f"Request {count} sent")
    if response.status_code != 201:
            print(count)




if response.status_code == 201:
    data = response.json()
    with open(os.path.join(script_dir,"test_res","bahn.json"),"w",encoding="utf-8") as qf:
        json.dump(data, qf, indent=4, ensure_ascii=False)

"""
data['verbindungen'][0]['verbindungsAbschnitte'][0]['halte'][0]['id']
data['verbindungen'][0]['verbindungsAbschnitte'][0]['halte'][0]['abfahrtsZeitpunkt']
data['verbindungen'][0]['verbindungsAbschnitte'][0]['halte'][0]['bahnhofsInfoId']
data['verbindungen'][0]['verbindungsAbschnitte'][0]['halte'][0]['extId']
data['verbindungen'][0]['verbindungsAbschnitte'][0]['halte'][0]['name']
data['verbindungen'][0]['ctxRecon']
data['verbindungen'][0]['verbindungsAbschnitte'][0]['halte'][0]
data['verbindungen'][0]['angebotsPreis']['betrag']
data['verbindungen'][0]['verbindungsAbschnitte'][0]['verkehrsmittel']['produktGattung']
data['verbindungen'][0]['verbindungsAbschnitte'][0]['verkehrsmittel']['name']
data['verbindungen'][0]['verbindungsAbschnitte'][0]['verkehrsmittel']['typ']
"""

"""
1. Verbindungen
    1.1 Abschnitte/Verkehrsmittel
        1.1.1 Halte


"""